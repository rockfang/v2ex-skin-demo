<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>V 站 Glass 主题定制</title>
  <!-- 预览专用样式（不参与导出） -->
  <link rel="stylesheet" href="./app-base.css">
  <style>
    :root{--panel-bg:#fff;--panel-line:rgba(0,0,0,.08);--gap:24px}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Helvetica,Arial;
      min-height:100vh;
      background:#f7f8fb;
      box-sizing:border-box
    }
    .content{display:grid;grid-template-columns:420px 1fr;gap:var(--gap);padding:12px 16px;box-sizing:border-box;height:calc(100vh - var(--topbar-h,56px));overflow:hidden}

    /* 顶部栏 */
    .topbar{position:sticky;top:0;z-index:20;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:#fff;border-bottom:1px solid rgba(0,0,0,.08)}
    .topbar .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .top-actions{display:flex;align-items:center;gap:10px}
    /* Switch 样式（对齐 demo2） */
    /* 先屏蔽预览区 .switch 的 ::after 旋钮等通用样式在顶部栏的影响 */
    .topbar .switch{position:relative;display:inline-block;width:46px;height:24px;cursor:pointer;vertical-align:middle;background:transparent;border:0}
    .topbar .switch::after{display:none;content:none}
    .topbar .switch input{display:none}
    .topbar .slider{position:absolute;inset:0;background:#cbd5e1;border-radius:999px;transition:background .2s ease}
    .topbar .slider:before{content:"";position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:transform .2s ease}
    .topbar .switch input:checked + .slider{background:var(--accent,#2563eb)}
    .topbar .switch input:checked + .slider:before{transform:translateX(22px)}
    .topbar .switch:focus-within .slider{outline:2px solid color-mix(in oklab, var(--accent,#2563eb) 45%, transparent); outline-offset:2px}

    /* 左侧设置面板 */
    .panel{border:1px solid var(--panel-line);border-radius:12px;padding:16px;background:#f3f5f8;height:100%;overflow:auto;box-sizing: border-box;}
    .panel h2{margin:2px 0 8px;font-size:16px}
    .row{display:flex;gap:8px;align-items:center;margin:10px 0}
    .row.first{justify-content:space-between}
    .theme-inline{display:flex;align-items:center;gap:8px}
    label{color:#475569;font-size:13px}
    .label-compact{width:auto;margin-right:6px}
    #night {
      width: 18px;
      height: 18px;
    }
    input[type="range"]{width:100%}
    select, textarea{border:1px solid var(--panel-line);border-radius:10px;padding:8px;background:#fff}
    /* 预设主题为平铺标签 */
    #preset{display:none}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .group .theme-inline{flex-direction:column;align-items:flex-start}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid var(--panel-line);background:#fff;color:#111416;cursor:pointer}
    .chip.active,.chip:hover{border-color:var(--accent,#2563eb);color:var(--accent,#2563eb)}
    /* 我的主题：删除按钮与管理模式 */
    #userChips .chip{position:relative}
    #userChips .chip .close{
      position:absolute;top:-8px;right:-8px;width:20px;height:20px;line-height:18px;
      border:1px solid rgba(0,0,0,.12);border-radius:999px;box-shadow:0 1px 2px rgba(0,0,0,.08);
      background:#fff;color:#64748b;font-weight:700;font-size:12px;
      cursor:pointer;opacity:0;transition:opacity .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
      padding:0;text-align:center
    }
    #userChips .chip .close:hover{background:#ef4444;border-color:#ef4444;color:#fff}
    #userChips .chip .close:focus-visible{outline:2px solid #ef4444;outline-offset:2px}
    /* 仅在悬浮时显示删除按钮 */
    #userChips .chip:hover .close{opacity:1}
    /* 夜间模式下的对比与阴影（不跟随 accent） */
    @supports selector(body:has(#Wrapper.Night)){
      body:has(#Wrapper.Night) #userChips .chip .close{
        background:#0f1115;color:#94a3b8;border-color:#334155;box-shadow:0 1px 2px rgba(0,0,0,.6)
      }
      body:has(#Wrapper.Night) #userChips .chip .close:hover{background:#ef4444;border-color:#ef4444;color:#fff}
    }
    /* 左侧卡片分组 */
    .group{margin:14px 0;background:#fff;border:1px solid var(--panel-line);border-radius:12px;padding:12px}
    .group .label{font-weight:600;margin-bottom:8px;color:#334155}
    .group .label .hint{font-weight:400;font-size:12px;color:#64748b;margin-left:8px}
    /* 隐藏旧的文案与分隔 */
    .panel .label-compact{display:none}
    .panel .divider,.panel h4,.panel .help{display:none}
    /* 隐藏预设主题内的第二列（Dark 文案） */
    .group > .theme-inline + .theme-inline{display:none}
    button{padding:8px 12px;border-radius:10px;border:1px solid var(--panel-line);background:#fafafa;cursor:pointer}
    .actions{display:flex;gap:12px;flex-wrap:nowrap;margin-top:8px;align-items:center;justify-content: space-between;}
    .link-btn{display:inline-flex;align-items:center;padding:8px 0;border:none;background:none;color:#555;font-size:13px;font-weight:600;text-decoration:underline;white-space:nowrap}
    .link-btn:hover{color:#333344}
    textarea{width:100%;height:280px;border-radius:12px;resize:vertical;margin-right: 10px;} /* 只纵向拉伸 */
    .divider{height:1px;background:var(--panel-line);margin:10px 0}

    /* 主按钮（固定高亮，不随主题） */
    .btn-primary{background:var(--accent,#2563eb);color:#fff;border:1px solid color-mix(in oklab, var(--accent,#2563eb) 60%, #000 40%);border-radius:8px;padding:8px 14px;font-weight:500}
    .btn-primary:hover{background:#1d4ed8}
    .btn-primary:active{background:#1e40af}
    .btn-primary:disabled{background:#93c5fd;border-color:#93c5fd;cursor:not-allowed}

    /* 使用方式 */
    .help{font-size:16px;line-height:1.65;color:#475569;background:#f3f5f8;border:1px dashed #d9dee7;border-radius:10px;padding:10px}
    .help b{font-weight:600}
    .help-steps{margin:0;padding-left:20px;color:inherit;font-size:15px;line-height:1.6}
    .help-steps li{margin-bottom:6px}
    .help-tip{margin:8px 0 0;font-size:13px;color:#64748b}

    /* 导出区：textarea 悬停显示右上角按钮 */
    .export-wrap{position:relative}
    .export-wrap .btn-compact{
      position:absolute;top:8px;right:8px;padding:6px 10px;font-size:12px;border-radius:6px;display:none;z-index:1
    }
    .export-wrap:hover .btn-compact{display:inline-block}

    /* 右侧预览框 */
    .preview{border:1px solid rgba(0,0,0,.08);border-radius:12px;overflow:hidden;background:#fff;height:100%}
    .preview-head{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px solid var(--line);background:var(--bg-elev)}
    .preview-title{display:none}
    /* 预览区只读徽标，随主题变化 */
    .preview-sub{font-size:12px;font-weight:600;padding:3px 8px;border-radius:999px;display:inline-block;
      border:1px solid color-mix(in oklab, var(--accent,#2563eb) 30%, var(--line));
      background:color-mix(in oklab, var(--accent,#2563eb) 16%, transparent);
      color:var(--text-1);
    }
    .preview-info{display:flex;flex-direction:row;align-items:center;gap:10px}
    .preview-hint{font-size:12px;color:var(--text-3)}
    .repo-link{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;color:var(--text-2,#475569);text-decoration:none;border:1px solid rgba(148,163,184,.4);transition:color .2s ease,background .2s ease,border-color .2s ease}
    .repo-link:hover{color:#1f2937;border-color:#94a3b8;background:rgba(148,163,184,.12)}
    .repo-link svg{width:16px;height:16px;fill:currentColor}
    /* 仅隐藏预览头部原有的 GitHub 图标，顶部栏保留 */
    .preview-head > .repo-link{display:none}
    
    /* 夜间模式也作用于左侧面板与顶部栏 */
    @supports selector(body:has(#Wrapper.Night)){
      body:has(#Wrapper.Night){background:#0f1115}
      body:has(#Wrapper.Night) .topbar{background:#0b0d10;border-bottom-color:#1f2937}
      body:has(#Wrapper.Night) .topbar .brand{color:#e5e7eb}
      body:has(#Wrapper.Night) .topbar .muted{color:#9aa3af !important}
      body:has(#Wrapper.Night) .panel{background:#111317;border-color:#1f2937;color:#e5e7eb}
      body:has(#Wrapper.Night) .group{background:#0f1216;border-color:#1f2937}
      body:has(#Wrapper.Night) .panel .label, 
      body:has(#Wrapper.Night) .panel label{color:#c6d0da}
      body:has(#Wrapper.Night) .group .label .hint{color:#94a3b8}
      body:has(#Wrapper.Night) .chip{background:#0000;color:#e5e7eb;border-color:#1f2937}
      /* Night 模式下，高亮 hover 与选中态 */
      body:has(#Wrapper.Night) .chip:hover{border-color:var(--accent,#2563eb);color:var(--accent,#2563eb)}
      body:has(#Wrapper.Night) .chip.active{
        border-color:var(--accent,#2563eb);
        color:#fff;
        background:color-mix(in oklab, var(--accent,#2563eb) 55%, #000);
      }
      body:has(#Wrapper.Night) .link-btn{color:#93c5fd}
      body:has(#Wrapper.Night) textarea{background:#0f1216;color:#e5e7eb;border-color:#1f2937}
      body:has(#Wrapper.Night) .btn-primary{background:color-mix(in oklab, var(--accent,#2563eb) 55%, #000);border-color:#334155}
      body:has(#Wrapper.Night) .btn-primary:hover{background:color-mix(in oklab, var(--accent,#2563eb) 65%, #000)}
    }
    /* 夜间模式也作用于左侧面板 */
    @supports selector(body:has(#Wrapper.Night)){
      body:has(#Wrapper.Night){background:#0f1115}
      body:has(#Wrapper.Night) .panel{background:#111317;border-color:#1f2937;color:#e5e7eb}
      body:has(#Wrapper.Night) .group{background:#0f1216;border-color:#1f2937}
      body:has(#Wrapper.Night) .panel .label, body:has(#Wrapper.Night) .panel label{color:#c6d0da}
      body:has(#Wrapper.Night) .chip{background:#0000;color:#e5e7eb;border-color:#1f2937}
      /* Night 模式下，高亮 hover 与选中态 */
      body:has(#Wrapper.Night) .chip:hover{border-color:var(--accent,#2563eb);color:var(--accent,#2563eb)}
      body:has(#Wrapper.Night) .chip.active{
        border-color:var(--accent,#2563eb);
        color:#fff;
        background:color-mix(in oklab, var(--accent,#2563eb) 55%, #000);
      }
      body:has(#Wrapper.Night) .link-btn{color:#93c5fd}
    }
  </style>
</head>
<body>
  <!-- 顶部栏：标题 + Dark 开关 + GitHub -->
  <header class="topbar">
    <div class="brand">
      <span>V 站 Glass 主题定制</span>
      <span class="muted" style="font-weight:400;color:#64748b">配置在左 · 预览在右</span>
    </div>
    <div class="top-actions">
      <span class="muted" style="color:#64748b">Dark</span>
      <label class="switch" title="Dark 模式">
        <input id="night" type="checkbox" />
        <span class="slider"></span>
      </label>
      <a class="repo-link" href="https://github.com/rockfang/v2ex-skin-demo" target="_blank" rel="noopener" aria-label="访问 GitHub 仓库">
        <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path d="M8 .198a8 8 0 0 0-2.53 15.59c.4.074.547-.174.547-.386 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.727-.497.055-.487.055-.487.804.057 1.227.826 1.227.826.714 1.223 1.873.87 2.329.665.072-.517.28-.87.508-1.07-1.777-.202-3.644-.888-3.644-3.955 0-.874.312-1.589.824-2.15-.083-.202-.357-1.017.078-2.12 0 0 .67-.215 2.195.82a7.64 7.64 0 0 1 2-.27 7.64 7.64 0 0 1 2 .27c1.524-1.035 2.193-.82 2.193-.82.437 1.103.163 1.918.08 2.12.513.561.823 1.276.823 2.15 0 3.075-1.87 3.75-3.652 3.95.288.25.544.739.544 1.49 0 1.075-.01 1.94-.01 2.204 0 .214.145.463.55.384A8 8 0 0 0 8 .198"/></svg>
      </a>
    </div>
  </header>
  <div class="content">
    <!-- 左侧设置 -->
    <aside class="panel">
      <h2>V 站 Glass 主题定制</h2>

      <div class="group">
        <div class="theme-inline">
          <div class="label">平台预设主题</div>
          <label class="label-compact">选择主题</label>
          <div class="chips" id="presetChips">
            <button class="chip" data-preset="rust">铁锈橙红</button>
            <button class="chip" data-preset="denim">深牛仔蓝</button>
            <button class="chip" data-preset="pine">松针绿</button>
            <button class="chip" data-preset="amber">琥珀色</button>
            <button class="chip" data-preset="slate">石板蓝灰</button>
            <button class="chip" data-preset="seafoam">海沫青绿</button>
          </div>
          <div class="theme-inline" id="userThemesBlock" style="margin-top:8px;align-items:flex-start;display:none">
            <div class="label">我的主题</div>
            <div class="chips" id="userChips"></div>
          </div>
          <select id="preset">
            <option value="denim">深牛仔蓝</option>
            <option value="pine">松针绿</option>
            <option value="amber">琥珀金</option>
            <option value="rust" selected>铁锈橙红</option>
            <option value="slate">石板蓝灰</option>
            <option value="seafoam">海沫青绿</option>
            <option value="custom">自定义</option>
          </select>
        </div>
        <div class="theme-inline">
          <label class="label-compact">Dark 模式</label>
          <input id="night_dummy" type="checkbox" style="display:none" disabled>
        </div>
      </div>

      <div class="group">
        <div class="label">主题定制 <span class="hint">可拖动下方滑块调整主题颜色</span></div>
        <div class="row"><label style="width:92px">Hue</label><input id="hue" type="range" min="0" max="360" value="18"><span id="huev">18</span></div>
      <div class="row"><label style="width:92px">Sat</label><input id="sat" type="range" min="0" max="100" value="66"><span id="satv">66%</span></div>
      <div class="row"><label style="width:92px">Light</label><input id="lit" type="range" min="0" max="100" value="50"><span id="litv">50%</span></div>

        <div class="actions">
        <button id="copyCss">复制 CSS</button>
        <button id="saveTheme" type="button" title="保存到本地" style="display:none">保存到我的主题</button>
        <button id="reset" style="display:none" aria-hidden="true" tabindex="-1"></button>
        <a class="link-btn" href="https://www.v2ex.com/settings" target="_blank" rel="noopener" aria-label="前往 V2EX 设置">&gt; V2EX 设置页</a>
        </div>
      </div>

      <div class="divider"></div>

      <h4>使用方式</h4>
      <div class="help">
        <ol class="help-steps">
          <li>在左侧选择预设主题，或拖动 Hue / Sat / Light 自定义主色；如需夜间预览，勾选 <b>Dark 模式</b>。</li>
          <li>确认右侧预览同步效果，必要时使用 <b>重置</b> 按钮恢复默认设置。</li>
          <li>点击 <b>复制完整 CSS</b> 按钮，将完整样式复制到剪贴板。</li>
          <li>前往 V2EX → 设置 → <b>自定义 CSS</b> 粘贴替换，即可生效。</li>
        </ol>
      </div>

      <div class="divider"></div>
      <h4>导出内容（完整 CSS）</h4>
      <div class="group" style="padding-right: 20px;">
        <div class="label">导出 CSS</div>
        <div class="export-wrap">
        <button id="copyCssFloat" class="btn-compact" type="button">复制 CSS</button>
        <textarea id="snippet" readonly></textarea>
      </div>
      </div>
    </aside>

    <!-- 右侧预览 -->
    <main class="preview" id="preview">
      <div class="preview-head">
        <div class="preview-info">
          <div class="preview-title" id="titleCN">主题效果预览：铁锈橙红</div>
          <div class="preview-sub">预览区（只读）</div>
          <div class="preview-hint">提示：此区域禁用交互，仅做视觉示意。真实效果请在 V 站替换 CSS 查看</div>
        </div>
        <a class="repo-link" href="https://github.com/rockfang/v2ex-skin-demo" target="_blank" rel="noopener" aria-label="访问 GitHub 仓库">
          <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false"><path d="M8 .198a8 8 0 0 0-2.53 15.59c.4.074.547-.174.547-.386 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.727-.497.055-.487.055-.487.804.057 1.227.826 1.227.826.714 1.223 1.873.87 2.329.665.072-.517.28-.87.508-1.07-1.777-.202-3.644-.888-3.644-3.955 0-.874.312-1.589.824-2.15-.083-.202-.357-1.017.078-2.12 0 0 .67-.215 2.195.82a7.64 7.64 0 0 1 2-.27 7.64 7.64 0 0 1 2 .27c1.524-1.035 2.193-.82 2.193-.82.437 1.103.163 1.918.08 2.12.513.561.823 1.276.823 2.15 0 3.075-1.87 3.75-3.652 3.95.288.25.544.739.544 1.49 0 1.075-.01 1.94-.01 2.204 0 .214.145.463.55.384A8 8 0 0 0 8 .198"/></svg>
        </a>
      </div>

      <!-- 顶部导航（含搜索） -->
      <div id="Top">
        <div class="nav">
          <div class="nav-left">
            <div class="brand">V2EX</div>
            <a href="javascript:;" class="nav-item active">技术</a>
            <a href="javascript:;" class="nav-item">创意</a>
            <a href="javascript:;" class="nav-item">好玩</a>
            <a href="javascript:;" class="nav-item">Apple</a>
            <a href="javascript:;" class="nav-item">程序员</a>
            <a href="javascript:;" class="nav-item">交易</a>
          </div>
          <div class="nav-right">
            <div class="search">
              <input type="search" placeholder="搜索…" aria-label="搜索"><kbd>/</kbd>
            </div>
            <a href="javascript:;" class="nav-item">设置</a>
            <a href="javascript:;" class="nav-item">登录</a>
          </div>
        </div>
      </div>

      <div id="Wrapper">
        <div class="layout">
          <!-- 左列 -->
          <div class="main">
            <!-- 帖子列表效果 -->
            <div class="sec">
              <div class="sec-title">帖子列表效果</div>

              <div class="cell topic_cardItem hoverable">
                <div class="row1">
                  <img class="cover" src="https://placehold.co/36x36" alt="">
                  <a class="topic_title" href="javascript:;">颠覆传统：开始“接触英语”！给浏览器装一个英语环境生成器</a>
                  <span class="replies badge">482</span>
                </div>
                <div class="row2 meta">
                  <a class="node" href="javascript:;">分享创造</a>
                  <span class="dot">?</span><a class="author" href="javascript:;">OrionRies</a>
                  <span class="dot">?</span><span class="time">8 分钟前</span>
                  <span class="pro">PRO</span>
                </div>
              </div>

              <div class="cell topic_cardItem hoverable">
                <div class="row1">
                  <img class="cover" src="https://placehold.co/36x36" alt="">
                  <a class="topic_title" href="javascript:;">BotGem 已经适配最新版 macOS 26</a>
                  <span class="replies badge">1</span>
                </div>
                <div class="row2 meta">
                  <a class="node" href="javascript:;">分享创造</a>
                  <span class="dot">?</span><a class="author" href="javascript:;">gaodeng</a>
                  <span class="dot">?</span><span class="time">17 分钟前</span>
                  <span class="last">最后回复来自 JJYing</span>
                </div>
              </div>
            </div>

            <!-- 普通卡片 -->
            <div class="sec">
              <div class="sec-title">普通卡片</div>
              <div class="box">
                <div class="card-title">这是一张普通信息卡片</div>
                <p class="card-desc">展示一般内容块与段落文本，观察卡片背景、边框与文本颜色在不同主题下的对比度。</p>
                <a href="javascript:;" class="link-more">了解更多 →</a>
              </div>
            </div>

            <!-- 回复卡片 -->
            <div class="sec">
              <div class="sec-title">回复卡片</div>
              <div class="cell reply">
                <img class="avatar" src="https://placehold.co/32x32" alt="">
                <div class="reply_body">
                  <div class="reply_meta">
                    <a class="author" href="javascript:;">zer0</a>
                    <span class="time">刚刚</span>
                  </div>
                  <div class="reply_content">卡片 hover 的阴影和提升高度很像 v 站新版 ??</div>
                </div>
              </div>
            </div>
          </div>

          <!-- 右列：组件展示（更好的排版） -->
          <aside class="side">
            <div class="sec">
              <div class="sec-title">组件展示</div>
              <div class="box">
                <div class="comp-grid">
                  <div class="comp-item">
                    <div class="comp-label">按钮</div>
                    <div class="btn-group">
                      <button class="normal button">普通按钮</button>
                      <button class="super button">强调按钮</button>
                    </div>
                  </div>

                  <div class="comp-item">
                    <div class="comp-label">开关灯</div>
                    <div class="switch-group">
                      <span class="switch on" aria-label="on" title="开启"></span>
                      <span class="switch" aria-label="off" title="关闭"></span>
                    </div>
                  </div>

                  <div class="comp-item">
                    <div class="comp-label">徽章/计数</div>
                    <div class="badge-group">
                      <a class="count_livid" href="javascript:;">23</a>
                      <span class="badge">482</span>
                    </div>
                  </div>
                </div> <!-- /comp-grid -->
              </div>
            </div>
          </aside>
        </div>
      </div>
    </main>
  </div>
  <script src="./app.js"></script>
  <script>
    // 让 chips 驱动隐藏的 select，从而复用现有 app.js 逻辑
    (function(){
      const chips = document.getElementById('presetChips');
      const sel = document.getElementById('preset');
      const userChips = document.getElementById('userChips');
      const userThemesBlock = document.getElementById('userThemesBlock');

      // 使内容高度与顶部栏自适应，避免底部不齐
      const header = document.querySelector('.topbar');
      function setTopbarVar(){
        const h = header ? header.offsetHeight : 56;
        document.documentElement.style.setProperty('--topbar-h', h + 'px');
      }
      setTopbarVar();
      window.addEventListener('resize', setTopbarVar);
      if(!chips || !sel) return;
      function getSavedThemes(){
        try{ return JSON.parse(localStorage.getItem('sg:savedThemes')||'[]'); }
        catch(e){ return []; }
      }
      function saveThemes(list){
        try{ localStorage.setItem('sg:savedThemes', JSON.stringify(list)); }
        catch(e){}
      }
      function renderUserChips(){
        if(!userChips) return;
        const list = getSavedThemes();
        userChips.innerHTML = '';
        // 有保存才展示“我的主题”区
        if(userThemesBlock){ userThemesBlock.style.display = list.length? '': 'none'; }
        list.forEach(item => {
          const btn = document.createElement('button');
          btn.className = 'chip';
          btn.setAttribute('data-user-theme', item.name);
          btn.innerHTML = `<span class="name"></span><button class="close" type="button" data-action="del" aria-label="删除 ${item.name}" title="删除">×</button>`;
          btn.querySelector('.name').textContent = item.name;
          userChips.appendChild(btn);
        });
      }
      renderUserChips();
      document.addEventListener('sg:savedThemesChanged', function(){
        renderUserChips();
        try{ refreshActive(); }catch(e){}
      });
      function refreshActive(){
        const H = +document.getElementById('hue').value;
        const S = +document.getElementById('sat').value;
        const L = +document.getElementById('lit').value;
        // 先匹配用户主题
        let userName = null;
        try{
          const list = JSON.parse(localStorage.getItem('sg:savedThemes')||'[]');
          const hit = Array.isArray(list) ? list.find(x=>+x.h===H && +x.s===S && +x.l===L) : null;
          if(hit) userName = hit.name;
        }catch(e){}
        // 再从 select 读取预设匹配（app.js 已维护好）
        const presetKey = (sel.value && sel.value !== 'custom') ? sel.value : null;
        // 优先高亮用户主题
        chips.querySelectorAll('.chip').forEach(c=>{
          const key = c.getAttribute('data-preset');
          c.classList.toggle('active', !userName && presetKey && key===presetKey);
        });
        if(userChips){
          userChips.querySelectorAll('.chip').forEach(c=>{
            c.classList.toggle('active', !!userName && c.getAttribute('data-user-theme')===userName);
          });
        }
      }
      chips.addEventListener('click', function(e){
        const btn = e.target.closest('.chip');
        if(!btn) return;
        const val = btn.getAttribute('data-preset');
        if(!val) return;
        sel.value = val;
        sel.dispatchEvent(new Event('change', { bubbles: true }));
        window.__sgActiveUserThemeName = null;
        refreshActive();
      });
      // 用户主题点击：直接设置 HSL 滑块并触发 input，让 app.js 接管
      userChips?.addEventListener('click', function(e){
        const delBtn = e.target.closest('[data-action="del"]');
        if(delBtn){
          const chip = delBtn.closest('.chip');
          if(!chip) return;
          const name = chip.getAttribute('data-user-theme');
          let list = getSavedThemes();
          list = list.filter(x=>x.name!==name);
          saveThemes(list);
          if(window.__sgActiveUserThemeName===name){ window.__sgActiveUserThemeName=null; }
          document.dispatchEvent(new CustomEvent('sg:savedThemesChanged'));
          refreshActive();
          e.stopPropagation();
          e.preventDefault();
          return;
        }
        const btn = e.target.closest('.chip');
        if(!btn) return;
        const name = btn.getAttribute('data-user-theme');
        const list = getSavedThemes();
        const item = list.find(x=>x.name===name);
        if(!item) return;
        const H = document.getElementById('hue');
        const S = document.getElementById('sat');
        const L = document.getElementById('lit');
        if(!H||!S||!L) return;
        window.__sgActiveUserThemeName = name;
        window.__sgApplyingUserTheme = true;
        H.value = item.h; S.value = item.s; L.value = item.l;
        H.dispatchEvent(new Event('input',{bubbles:true}));
        S.dispatchEvent(new Event('input',{bubbles:true}));
        L.dispatchEvent(new Event('input',{bubbles:true}));
        // 微任务后清理标记，确保 applyVars 完整运行
        setTimeout(()=>{ window.__sgApplyingUserTheme = false; },0);
        sel.value = 'custom';
        sel.dispatchEvent(new Event('change', { bubbles: true }));
        refreshActive();
      });
      sel.addEventListener('change', function(){ refreshActive(); });
      // 当手动拖动 H/S/L 滑块时，app.js 会把 select 设为匹配预设或 custom
      // 这里在同一 input 事件后刷新 chips 的激活态，根据匹配结果高亮或不高亮
      ['hue','sat','lit'].forEach(function(id){
        var el = document.getElementById(id);
        if(el){ el.addEventListener('input', function(){ window.__sgActiveUserThemeName=null; refreshActive(); }); }
      });
      // 首次加载时，同步一次 chips 激活态
      refreshActive();
    })();
  </script>
</body>
</html>








